
---
# Register machines to Satellite 6.X
- name: SATELLITE | Download bootstrap.py from the {{ satellite_fqdn }}
  get_url:
    url: "http://{{ satellite_fqdn }}/pub/bootstrap.py"
    dest: /usr/local/sbin/bootstrap.py
    mode: 0755
    owner: root
    group: root
  when: satellite_hostgroup != 'false'
  register: sat_url_result
  until: sat_url_result | succeeded
  retries: 10
  delay: 1
  ignore_errors: yes

- name: SATELLITE | Register to Satellite 6 through bootstrap.py
  command: "/usr/local/sbin/bootstrap.py -l {{ satellite_admin_user | default('foreman')}} -p {{ satellite_admin_pass }} -s {{ satellite_fqdn }} -o {{ org | default('Default Organization')}} -L {{ satellite_location }} -g {{ satellite_hostgroup }} -a {{ activation_key }}"
  when: satellite_hostgroup != 'false'

- name: SATELLITE | Install the katello-ca-consumer-latest.noarch.rpm from {{ satellite_fqdn }}
  yum:
    name: http://{{ satellite_fqdn }}/pub/katello-ca-consumer-latest.noarch.rpm
    state: present
  when: satellite_hostgroup == 'false'

- name: SATELLITE |  Register to Satellite, will only receive content views
  redhat_subscription:
    state: present
    activationkey: "{{ activation_key }}"
    org_id: "{{ satellite_org }}"
    autosubscribe: "{{ auto_subscribe | default('false')}}"
  when: satellite_hostgroup == 'false'
  register: 'registration_return'

- name: Satellite | Install the katello-agent
  yum:
    name: katello-agent
    state: latest
  when: satellite_hostgroup == 'false' and registration_return|success
  notify: enable katello-agent

- name: Satellite | Update all packages on host
  yum:
    name: '*'
    state: latest
  when: update_packages != 'false'

# - name: Get last used activation key
#   slurp:
#     src: /tmp/ansible-satellite_register-activation_key
#   register: last_activation_key
#
# - name: Get Subscription Manager status
#   command: subscription-manager status
#   failed_when: False
#   changed_when: False
#   register: subscription_manager_status
#
# - block:
#     - name: Write last used activation key to file
#       copy:
#         dest: /tmp/ansible-satellite_register-activation_key
#         content: "{{ satellite_activation_key }}"
#
#     - name: Clean Subscription Manager
#       command: subscription-manager clean
#
#     - name: Install Satellite CA Certificate
#       yum:
#         state: present
#         name: "http://{{ satellite_url }}/pub/katello-ca-consumer-latest.noarch.rpm"
#
#     - name: Register
#       redhat_subscription:
#         state: present
#         org_id: "{{ satellite_org }}"
#         activationkey: "{{ satellite_activation_key }}"
#
#     - name: Install katello-agent
#       yum:
#         state: present
#         name: katello-agent
#   when:
#     - subscription_manager_status.rc != 0 or
#       last_activation_key|failed or
#       (last_activation_key['content'] | b64decode) != satellite_activation_key
